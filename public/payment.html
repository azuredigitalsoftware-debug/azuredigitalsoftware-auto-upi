<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Complete Payment | Azure Digital Software</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{
  margin:0;
  background:#020617;
  color:#fff;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter",sans-serif;
}

/* HEADER */
.header{
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #1f2937;
}
.header-title{font-weight:700;font-size:16px;}
.header-tag{
  padding:4px 10px;
  border-radius:999px;
  background:#00ffc6;
  color:#022c22;
  font-size:11px;
}

/* WRAPPER */
.container{
  max-width:480px;
  margin:0 auto;
  padding:18px 16px 90px;
}

/* ORDER CARD */
.order-card{
  background:#020617;
  border-radius:16px;
  border:1px solid #1f2937;
  padding:14px 14px 16px;
  box-shadow:0 10px 40px rgba(0,0,0,0.7);
}
.order-title{font-size:15px;font-weight:600;}
.order-meta{font-size:12px;opacity:.7;margin-top:2px;}
.order-price{
  font-size:22px;
  font-weight:800;
  color:#00ffc6;
  margin-top:6px;
}
.order-id{font-size:12px;opacity:.75;margin-top:4px;}

/* QR BOX */
.qr-card{
  margin-top:16px;
  background:#020617;
  border-radius:16px;
  border:1px solid #1f2937;
  padding:14px;
  text-align:center;
}
.qr-image{
  width:210px;
  max-width:70%;
  border-radius:12px;
  background:#fff;
  padding:8px;
  margin:auto;
  display:block;
}
.qr-note{
  font-size:11px;
  opacity:.7;
  margin-top:8px;
}

/* UPI APP BUTTONS */
.pay-options{
  width:100%;
  margin-top:18px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.pay-btn{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.4);
  background:#e8e9ed;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  transition:.25s;
}
.pay-btn:hover{
  transform:scale(1.03);
  border-color:#00ffc6;
  box-shadow:0 0 16px rgba(0,255,198,.25);
}
.pay-btn img{
  width:26px;
  height:26px;
  border-radius:50%;
}
.other-note{
  margin-top:10px;
  font-size:12px;
  opacity:.7;
}

.accepted-list{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:8px;font-size:13px}
.accepted-list img{width:22px;height:22px;border-radius:4px;display:inline-block}
.accepted-item{display:flex;gap:10px;align-items:center;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);cursor:pointer;transition:all .18s;min-width:140px;flex:0 0 auto}
.accepted-item:hover{transform:translateY(-3px);border-color:#00ffc6;box-shadow:0 8px 20px rgba(0,255,198,0.06)}
.accepted-item img{width:28px;height:28px;border-radius:6px}
/* compact static layout on mobile */
@media (max-width:480px){
  .accepted-list{flex-direction:row;gap:8px;padding:6px 0;overflow-x:visible;justify-content:space-between;align-items:center}
  .accepted-item{flex:1 1 0;min-width:0;justify-content:center;padding:8px;border-radius:10px}
  .accepted-item img{width:22px;height:22px}
  .accepted-item span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px}
}

/* VERIFICATION BOX */
.verify-box{
  margin-top:20px;
  background:#020617;
  border-radius:16px;
  border:1px solid #1f2937;
  padding:14px;
}
.verify-title{
  font-size:14px;
  font-weight:600;
}
.verify-status{
  margin-top:6px;
  font-size:13px;
  opacity:.85;
}
.verify-timer{
  margin-top:6px;
  font-size:13px;
  color:#fbbf24;
}
.loader{
  margin-top:10px;
  font-size:30px;
  text-align:center;
  animation:pulse 1.4s infinite;
}
@keyframes pulse{
  0%{opacity:.3;transform:scale(.9);}
  50%{opacity:1;transform:scale(1.05);}
  100%{opacity:.3;transform:scale(.9);}
}

/* ACTION BUTTONS */
.action-row{
  margin-top:14px;
  display:none;
  flex-direction:column;
  gap:10px;
}
.primary-btn, .secondary-btn, .ghost-btn{
  width:100%;
  padding:12px;
  border-radius:12px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  border:none;
}
.primary-btn{
  background:#22c55e;
  color:#022c22;
}
.secondary-btn{
  background:#0f172a;
  color:#e5e7eb;
  border:1px solid #374151;
}
.ghost-btn{
  background:transparent;
  color:#9ca3af;
  border:1px dashed #4b5563;
}

/* POPUP UPLOAD */
.backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:20;
}
.popup{
  width:90%;
  max-width:360px;
  background:#020617;
  border-radius:16px;
  border:1px solid #1f2937;
  padding:16px;
}
.popup h3{font-size:16px;margin-bottom:6px;}
.popup small{font-size:12px;opacity:.75;}
.popup input[type="file"]{
  margin-top:10px;
  width:100%;
}
.popup-btn{
  margin-top:12px;
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
}
.popup-primary{
  background:#00ffc6;
  color:#022c22;
}
.popup-cancel{
  background:#020617;
  border:1px solid #4b5563;
  color:#e5e7eb;
}

/* FOOTER NOTE */
.footer-note{
  margin-top:14px;
  font-size:11px;
  opacity:.7;
  text-align:center;
}
.success-text{color:#22c55e;}
.error-text{color:#f97373;}

@media(min-width:700px){
  .container{padding-bottom:30px;}
}

/* Mobile adjustments */
@media (max-width:480px){
  html,body{ -webkit-text-size-adjust:100%; }
  .container{padding:20px 12px 120px;}
  .qr-image{width:80%;max-width:260px}
  .qr-card{padding:12px}
  .order-price{font-size:20px}
  .order-title{font-size:16px}
  .header{padding:12px 14px}
  .accepted-list{gap:10px;font-size:14px}
  .accepted-list > div{display:flex;gap:8px;align-items:center}
  .primary-btn, .secondary-btn, .popup-btn{padding:14px}
  .popup{width:95%;max-width:400px}
  .verify-title{font-size:15px}
  .verify-status{font-size:14px}
  /* mobile actions removed */
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">Complete Your Payment</div>
  <div class="header-tag">üîí Secure UPI</div>
</div>

<div class="container">

  <!-- ORDER SUMMARY -->
  <div class="order-card">
    <div class="order-title">Filmora 14 Lifetime Premium</div>
    <div class="order-meta">1 PC ‚Ä¢ Lifetime License ‚Ä¢ Instant Email Delivery</div>
    <div class="order-price">‚Çπ199</div>
    <div class="order-id">Order ID: <span id="orderIdLabel"></span></div>
  </div>

  <!-- QR CODE -->
  <div class="qr-card">
    <img id="qrImage" class="qr-image" src="" alt="UPI QR">
    <div class="qr-note">
      Scan with Google Pay / PhonePe / Paytm or any UPI app.  
      Amount & details will be auto-filled.
    </div>
  </div>

    <!-- Accepted payment methods -->
    <div class="other-note">
      <div>Payment accepted:</div>
      <div class="accepted-list" role="list">
        <div class="accepted-item" role="button" tabindex="0" title="Pay using Google Pay">
          <img src="uploads/google pay.webp" alt="Google Pay">
          <span>Google Pay</span>
        </div>
        <div class="accepted-item" role="button" tabindex="0" title="Pay using PhonePe">
          <img src="uploads/OIP (2).webp" alt="PhonePe">
          <span>PhonePe</span>
        </div>
        <div class="accepted-item" role="button" tabindex="0" title="Pay using Paytm">
          <img src="uploads/download.webp" alt="Paytm">
          <span>Paytm</span>
        </div>
      </div>
    </div>

    <!-- UPI details removed per request -->

  <!-- VERIFICATION BOX -->
  <div class="verify-box" id="verifyBox">
    <div class="verify-title" id="verifyTitle">Waiting for payment‚Ä¶</div>
    <div class="verify-status" id="verifyStatus">
      Please complete the UPI payment in your selected app.  
      Once done, we‚Äôll verify and unlock your download.
    </div>
    <div class="verify-timer" id="verifyTimer">We‚Äôll auto-check in a few seconds‚Ä¶</div>
    <div class="loader" id="loaderIcon">üöÄ</div>

    <div class="action-row" id="actionRow">
      <button class="primary-btn" onclick="openUpload()">‚úî I HAVE PAID</button>
      <button class="secondary-btn" onclick="openUpload()">üì§ Upload payment screenshot</button>
    </div>
  </div>

  <div class="footer-note" id="footerNote">
    If your payment is approved, you will be automatically redirected to the success page.  
    If not, our team will verify it manually within a few minutes.
  </div>

</div>

<!-- POPUP FOR UPLOAD -->
<div class="backdrop" id="uploadBackdrop">
  <div class="popup">
    <h3>Upload UPI Payment Screenshot</h3>
    <small>Make sure the Transaction ID, Amount and Name is visible.</small>
    <input type="file" id="proofFile" accept="image/*">
    <button class="popup-btn popup-primary" onclick="submitProof()">Submit Screenshot</button>
    <button class="popup-btn popup-cancel" onclick="closePopup()">Cancel</button>
    <div id="uploadMsg" style="margin-top:6px;font-size:12px;"></div>
  </div>
</div>

<!-- QR modal (enlarged view) -->
<!-- QR modal removed per request -->

<script>
/* ---------- CONFIG ---------- */
const upiID = "azuredigitalsoftware@nsdl";            // your UPI ID
const receiverName = "Azure Digital Software";       // your display name
const amount = "199";                                // amount in INR

let lastPaymentLink = "";                            // remember last UPI link
let orderId = localStorage.getItem("orderID");       // from checkout.php

if(!orderId){
  // if no order id, send back to checkout
  window.location.href = "checkout.html";
}

document.getElementById("orderIdLabel").innerText = orderId;

/* ---------- GENERATE UPI & QR ---------- */
function baseUPILink(){
  return `upi://pay?pa=${upiID}&pn=${encodeURIComponent(receiverName)}&am=${amount}&cu=INR&tn=Order%20${orderId}&tr=${orderId}`;
}

function generateQR(){
  const link = baseUPILink();
  document.getElementById("qrImage").src =
    "https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=" + encodeURIComponent(link);
}
generateQR();

/* ---------- UPI APP HANDLERS ---------- */
function payWith(app){
  let link = baseUPILink();

  if(app === "gpay"){
    link = `gpay://upi/pay?pa=${upiID}&pn=${encodeURIComponent(receiverName)}&am=${amount}&cu=INR&tr=${orderId}`;
  } else if(app === "phonepe"){
    link = `phonepe://pay?pa=${upiID}&pn=${encodeURIComponent(receiverName)}&am=${amount}&cu=INR&tr=${orderId}`;
  } else if(app === "paytm"){
    link = `paytmmp://pay?pa=${upiID}&pn=${encodeURIComponent(receiverName)}&am=${amount}&cu=INR&tr=${orderId}`;
  }

  lastPaymentLink = link;
  startVerificationFlow();
  // Do not automatically redirect to the UPI app anymore.
  // Instead, prepare the link and try to copy it so the user can paste it into their UPI app.
  if (navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(link).then(()=>{
      document.getElementById("verifyStatus").innerText = "UPI link copied to clipboard. Open your UPI app and paste it to pay. Click 'I HAVE PAID' after completing payment.";
    }).catch(()=>{
      document.getElementById("verifyStatus").innerText = "UPI link prepared. Please open your UPI app and use the UPI ID or the QR code to pay. Click 'I HAVE PAID' after completing payment.";
    });
  } else {
    document.getElementById("verifyStatus").innerText = "UPI link prepared. Please open your UPI app and use the UPI ID or the QR code to pay. Click 'I HAVE PAID' after completing payment.";
  }
}

function reopenUPI(){
  if(lastPaymentLink){
    window.location.href = lastPaymentLink;
  } else {
    window.location.href = baseUPILink();
  }
}


/* ---------- HYBRID VERIFICATION FLOW (12s) ---------- */
let verifyTimerId = null;
function startVerificationFlow(){
  const title = document.getElementById("verifyTitle");
  const status = document.getElementById("verifyStatus");
  const timer = document.getElementById("verifyTimer");
  const loader = document.getElementById("loaderIcon");
  const actions = document.getElementById("actionRow");

  title.innerText = "Verifying payment‚Ä¶";
  status.innerText = "Please don‚Äôt close this page. If your payment is successful, we‚Äôll confirm it shortly.";
  let sec = 12;
  timer.innerText = `Checking with bank‚Ä¶ ${sec}s`;
  loader.innerText = "üîÑ";
  actions.style.display = "none";

  if(verifyTimerId) clearInterval(verifyTimerId);
  verifyTimerId = setInterval(()=>{
    sec--;
    timer.innerText = `Checking with bank‚Ä¶ ${sec}s`;
    if(sec <= 0){
      clearInterval(verifyTimerId);
      title.innerText = "Almost there ‚Äî we just need your confirmation";
      status.innerText = "If you‚Äôve completed the payment, please upload the screenshot so we can verify faster.";
      timer.innerText = "Tap ‚ÄúUpload payment screenshot‚Äù to continue.";
      loader.innerText = "‚úÖ";
      actions.style.display = "flex";
    }
  },1000);
}

/* ---------- UPLOAD POPUP ---------- */
function openUpload(){
  document.getElementById("uploadBackdrop").style.display = "flex";
}
function closePopup(){
  document.getElementById("uploadBackdrop").style.display = "none";
}

/* ---------- SUBMIT PROOF ---------- */
async function submitProof(){
  const fileInput = document.getElementById("proofFile");
  const msg = document.getElementById("uploadMsg");
  msg.innerText = "";
  msg.className = "";

  if(!fileInput.files[0]){
    msg.innerText = "Please select a screenshot file.";
    msg.className = "error-text";
    return;
  }

  const fd = new FormData();
  fd.append("orderId", orderId);
  fd.append("screenshot", fileInput.files[0]);

  try{
    const res = await fetch("/api/upload-proof", {
      method:"POST",
      body: fd
    });
    const data = await res.json();

    if(data.success){
      msg.innerText = "Screenshot uploaded. Verifying your payment‚Ä¶";
      msg.className = "success-text";
      closePopup();
      document.getElementById("verifyTitle").innerText = "Payment proof received";
      document.getElementById("verifyStatus").innerText = "We‚Äôre verifying your payment. This usually takes a few minutes.";
      document.getElementById("verifyTimer").innerText = "You‚Äôll be redirected automatically when approved.";
      document.getElementById("loaderIcon").innerText = "üîç";
      startPollingStatus();
    } else {
      msg.innerText = "Upload failed: " + (data.message || "Try again");
      msg.className = "error-text";
    }
  }catch(e){
    msg.innerText = "Network error. Please try again.";
    msg.className = "error-text";
  }
}

/* ---------- POLL ORDER STATUS ---------- */
let pollInterval = null;
function startPollingStatus(){
  if(pollInterval) clearInterval(pollInterval);
  pollInterval = setInterval(checkStatus, 4000);
}

async function checkStatus(){
  try{
    const res = await fetch(`/api/order-status/${encodeURIComponent(orderId)}`);
    const data = await res.json();

    if(!data.status) return;

    const title = document.getElementById("verifyTitle");
    const status = document.getElementById("verifyStatus");
    const timer = document.getElementById("verifyTimer");
    const loader = document.getElementById("loaderIcon");
    const footer = document.getElementById("footerNote");

    if(data.status === "approved"){
      clearInterval(pollInterval);
      title.innerText = "Payment Approved üéâ";
      status.innerText = "Your payment has been verified. We‚Äôre redirecting you to your download page.";
      timer.innerText = "";
      loader.innerText = "üéâ";
      footer.className = "footer-note success-text";
      footer.innerText = "Payment successful. Redirecting‚Ä¶";
      setTimeout(()=>{ window.location.href = "success.html"; }, 2500);
    } else if(data.status === "rejected"){
      clearInterval(pollInterval);
      title.innerText = "Payment Could Not Be Verified";
      status.innerText = "Your payment could not be confirmed automatically. Please contact support or try again.";
      timer.innerText = "";
      loader.innerText = "‚ö†Ô∏è";
      footer.className = "footer-note error-text";
      footer.innerText = "If money was deducted but status is rejected, please contact support with your UPI reference ID.";
    }
  }catch(e){
    // silent fail; will retry
  }
}

// Start verification flow once page loads (soft mode)
startVerificationFlow();
</script>

</body>
</html>
