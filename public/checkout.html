<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout | Azure Digital Software</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="preload" href="styles.min.css" as="style" onload="this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="styles.min.css"></noscript>

  <style>
    /* Page-specific compact overrides */
    body{background:#020617;color:#fff;font-family:'Inter',sans-serif;margin:0;padding:18px;display:flex;justify-content:center}
    .box{max-width:540px;width:100%;background:#0b0b12;border-radius:18px;border:1px solid #1f2937;padding:18px;box-shadow:0 8px 40px rgba(0,0,0,.6);overflow:hidden}
    h1{text-align:center;margin-bottom:12px;font-weight:700}
    .top-row{display:flex;gap:12px;align-items:center}
    .thumb{width:96px;height:64px;border-radius:10px;overflow:hidden;flex:0 0 96px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .summary{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:10px;border:1px solid rgba(255,255,255,0.03);padding:10px;margin-bottom:14px;font-size:14px}
    .summary div{display:flex;justify-content:space-between;margin:2px 0;align-items:center}
    .rating{color:#fbbf24;font-weight:800;font-size:14px;margin-left:6px}

    label{display:block;font-size:13px;margin-top:8px;margin-bottom:6px}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #111827;background:#020617;color:#fff;font-size:14px}
    textarea{height:80px;resize:none}

    .checkout-btn{width:100%;padding:14px;margin-top:14px;border-radius:14px;background:linear-gradient(90deg,#00ffc6,#0096ff);color:#00261a;font-size:18px;font-weight:800;cursor:pointer;border:none;display:flex;justify-content:center;align-items:center;gap:8px;transition:transform .25s ease,box-shadow .25s;box-shadow:0 8px 28px rgba(0,255,198,0.14)}
    .checkout-btn:hover{transform:translateY(-3px);box-shadow:0 18px 48px rgba(0,255,198,0.18)}
    .checkout-btn.loading{pointer-events:none;opacity:.7;background:linear-gradient(90deg,#3b3b3b,#6d6d6d);color:#fff}

    .pay-hint{font-size:13px;color:#9ca3af;text-align:center;margin-top:10px}

    .msg{margin-top:10px;font-size:13px;color:#9ca3af;text-align:center}

    /* Success panel */
    .success{display:none;padding:18px;border-radius:12px;background:linear-gradient(180deg,#052024,#07303a);text-align:center;margin-top:12px}
    .success.show{display:block}
    .success .check{font-size:40px;color:#00ffc6;display:block;margin-bottom:8px}
    .upi-box{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
    .upi-id{background:#011;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);font-weight:700}
    .copy-btn{background:#00ffc6;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}

    @media(max-width:520px){.top-row{flex-direction:column;align-items:flex-start}.thumb{width:100%;height:120px}.summary{width:100%}}
  </style>
</head>

<body>
<div class="box">
  <h1>Checkout</h1>

  <div class="top-row">
    <div class="thumb"><img src="optimized-uploads/filmora ads 1.png" alt="product" loading="lazy"></div>
    <div class="summary" id="cartSummary">
      <div id="cartItems">
        <!-- cart items will be injected here -->
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:8px;align-items:center">
        <div style="font-size:13px;color:#9ca3af">Total</div>
        <div id="cartTotal" style="font-weight:800;font-size:18px;color:#00ffc6">â‚¹0</div>
      </div>
    </div>
  </div>

  <label>Full Name *</label>
  <input id="name" required placeholder="Your name">

  <label>Email *</label>
  <input id="email" type="email" required placeholder="you@gmail.com">

  <label>Phone (optional)</label>
  <input id="phone" placeholder="10-digit number">

  <label>Notes (optional)</label>
  <textarea id="notes" placeholder="Any special request?"></textarea>

  <button id="checkoutBtn" class="checkout-btn" onclick="createOrder()">
    âš¡ Pay & Unlock Now
  </button>

  <p class="pay-hint">ðŸ”’ 100% Secure â€¢ No Subscription â€¢ Lifetime Access</p>

  <div class="msg" id="msg">No auto-debit. You will pay via UPI after order creation.</div>

  <div id="successPanel" class="success" role="status" aria-live="polite">
    <div class="check">âœ”</div>
    <div class="title"><strong>Order created</strong></div>
    <div class="subtitle">We've created your order â€” complete payment using UPI</div>
    <div class="upi-box">
      <div class="upi-id" id="upiId">azure@upi</div>
      <button class="copy-btn" id="copyUpi">Copy</button>
    </div>
    <div style="margin-top:10px;font-size:13px;color:#9ca3af">Order ID: <span id="orderRef">-</span></div>
    <div style="margin-top:12px">
      <a href="payment.html" style="text-decoration:none"><button class="checkout-btn" style="padding:10px 18px;margin-top:8px">Proceed to Payment</button></a>
    </div>
  </div>
</div>

<script>
function setLoading(state) {
  const btn = document.getElementById("checkoutBtn");
  if (state) {
    btn.innerHTML = "âŒ› Processing...";
    btn.classList.add("loading");
  } else {
    btn.innerHTML = "âš¡ Pay & Unlock Now";
    btn.classList.remove("loading");
  }
}

// populate cart summary from localStorage with qty controls
(function(){
  const itemsEl = document.getElementById('cartItems');
  const totalEl = document.getElementById('cartTotal');
  const checkoutBtn = document.getElementById('checkoutBtn');

  function getCart(){ try{ return JSON.parse(localStorage.getItem('ads_cart')||'[]'); }catch(e){return []} }
  function setCart(c){ localStorage.setItem('ads_cart', JSON.stringify(c)); render(); }

  function formatPrice(n){ return 'â‚¹'+Math.round(n); }

  function render(){
    const cart = getCart();
    if(!itemsEl || !totalEl) return;
    if(!cart || cart.length===0){
      itemsEl.innerHTML = '<div style="padding:10px 0;color:#9ca3af">Your cart is empty. Add items from the product page.</div>';
      totalEl.textContent = 'â‚¹0';
      checkoutBtn.disabled = true;
      return;
    }

    checkoutBtn.disabled = false;
    itemsEl.innerHTML = '';
    let total = 0;

    cart.forEach(item=>{
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='8px 0';

      const left = document.createElement('div'); left.style.maxWidth='60%';
      left.innerHTML = `<div style=\"font-weight:700;\">${item.name}</div><div style=\"font-size:13px;color:#9ca3af;\">${item.priceTxt || ''} ${item.oldTxt?('<span style=\\"text-decoration:line-through;margin-left:6px;color:#f87171\\">'+item.oldTxt+'</span>'):''}</div>`;

      const center = document.createElement('div'); center.style.display='flex'; center.style.alignItems='center'; center.style.gap='6px';
      // decrement button
      const dec = document.createElement('button'); dec.textContent='âˆ’'; dec.style.padding='6px 10px'; dec.style.borderRadius='8px'; dec.style.border='1px solid rgba(255,255,255,0.06)'; dec.style.background='transparent'; dec.style.color='#00ffc6'; dec.style.cursor='pointer';
      // qty display
      const qty = document.createElement('span'); qty.textContent = item.qty; qty.style.minWidth='28px'; qty.style.textAlign='center'; qty.style.display='inline-block'; qty.style.fontWeight='700';
      // increment button
      const inc = document.createElement('button'); inc.textContent='+'; inc.style.padding='6px 10px'; inc.style.borderRadius='8px'; inc.style.border='1px solid rgba(255,255,255,0.06)'; inc.style.background='transparent'; inc.style.color='#00ffc6'; inc.style.cursor='pointer';

      center.appendChild(dec); center.appendChild(qty); center.appendChild(inc);

      const right = document.createElement('div'); right.style.fontWeight='800'; right.textContent = formatPrice(item.price * item.qty);

      row.appendChild(left);
      row.appendChild(center);
      row.appendChild(right);

      // attach events
      dec.addEventListener('click', ()=>{
        const cart = getCart(); const idx = cart.findIndex(i=>i.id===item.id); if(idx===-1) return;
        cart[idx].qty = (cart[idx].qty||1) - 1;
        if(cart[idx].qty <= 0){ cart.splice(idx,1); }
        setCart(cart);
      });
      inc.addEventListener('click', ()=>{
        const cart = getCart(); const idx = cart.findIndex(i=>i.id===item.id); if(idx===-1) return;
        cart[idx].qty = (cart[idx].qty||1) + 1;
        setCart(cart);
      });

      itemsEl.appendChild(row);
      total += (item.price * item.qty);
    });

    totalEl.textContent = formatPrice(total);
  }

  // initial render
  render();
})();

async function createOrder() {
  setLoading(true);

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const msg = document.getElementById("msg");

  if (!name || !email) {
    msg.textContent = "âš  Please enter name and email.";
    msg.style.color = "#ff6b6b";
    setLoading(false);
    return;
  }

  const payload = { name, email, phone };
  function fetchWithTimeout(url, opts, timeout = 4000) {
    return Promise.race([
      fetch(url, opts),
      new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), timeout))
    ]);
  }

  try {
    const res = await fetchWithTimeout('/api/create-order', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }, 4000);
    const data = await res.json();
    if (data && data.success) {
      // persist order locally for dashboard
      const cart = JSON.parse(localStorage.getItem('ads_cart')||'[]');
      const localOrders = JSON.parse(localStorage.getItem('ads_local_orders')||'[]');
      const orderObj = { id: data.orderId, name, email, phone, items: cart, status: 'pending', createdAt: new Date().toISOString() };
      localOrders.push(orderObj);
      localStorage.setItem('ads_local_orders', JSON.stringify(localOrders));
      // clear cart after order
      localStorage.removeItem('ads_cart');
      localStorage.setItem('orderID', data.orderId);
      window.location.href = 'payment.html';
      return;
    }
  } catch (e) {
    // fallback to simulated order so user sees instant response
  }

  // Simulated quick response: create a local order and redirect to payment page
  const orderId = 'SIM-'+Date.now();
  // persist simulated order locally
  const cart = JSON.parse(localStorage.getItem('ads_cart')||'[]');
  const localOrders = JSON.parse(localStorage.getItem('ads_local_orders')||'[]');
  const orderObj = { id: orderId, name, email, phone, items: cart, status: 'pending', createdAt: new Date().toISOString() };
  localOrders.push(orderObj);
  localStorage.setItem('ads_local_orders', JSON.stringify(localOrders));
  // clear cart after creating order
  localStorage.removeItem('ads_cart');
  localStorage.setItem('orderID', orderId);
  // redirect user directly to payment flow where payment.html will read orderID from localStorage
  window.location.href = 'payment.html';
}

// copy UPI
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'copyUpi'){
    const upi = document.getElementById('upiId').textContent.trim();
    navigator.clipboard?.writeText(upi).then(()=>{
      e.target.textContent = 'Copied';
      setTimeout(()=> e.target.textContent = 'Copy',1200);
    }).catch(()=>{ alert('Copy not supported') });
  }
});

// prefill name/email if user logged in
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const user = JSON.parse(localStorage.getItem('ads_user')||'null');
    if(user){ if(user.name) document.getElementById('name').value = user.name; if(user.email) document.getElementById('email').value = user.email; }
  }catch(e){}
});
</script>

</body>
</html>
